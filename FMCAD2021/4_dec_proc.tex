%!TEX root = paper.tex

Sem\"{e}nov first proved that  {\paexp} admits quantifier elimination in \cite{Semenov84}, thus its satisfiability problem is decidable. However, Sem\"{e}nov did not give a concrete quantifier elimination algorithm. Remedying this, Point proposed a quantifier elimination algorithm for {\paexp} in \cite{Point86}. In the sequel, we are going to illustrate how Point's quantifier elimination algorithm works. Points' algorithm is non-elementary in the worst case and a faithful implementation of the algorithm would not scale\footnote{We did implemented Point's algorithm and discovered that the implementation could only solve formulas of very small size.}. In the next section, we will propose various optimizations to Point's algorithm, aiming at an efficient implementation. 

Specifically, in the sequel, we are going to show that for every {\paexp} formula $\exists \ivarx.\ \varphi \in \paexp$, where $\varphi$ is quantifier-free, can be transformed into an equivalent quantifier-free formula $\varphi' \in \paexp$.
% such that $\free(\varphi') = \free(\varphi) \setminus \{\ivarx\}$. 
%From this, we can easily derive that every {\paexp} formula $\varphi$ can be transformed effectively into an equivalent quantifier-free Presburger arithmetic formula $\varphi'$.

Before a formal description of the quantifier elimination procedure, let us use a simple example to illustrate the main idea and give an overview of the procedure.

%\begin{example}
\subsection{Overview of the quantifier elimination procedure}
Consider $\varphi \Def \exists \ivarx_2.\ 10^{\ivarx_1 + \ivarx_2} - 10^{\ivarx_2} \le \ivary + 1001$. 

At first, we \emph{normalize} $\varphi$ by introducing a fresh variable $\ivarx_3$ for $\ivarx_1 + \ivarx_2$ and get the formula 
$$\varphi_1 \Def \exists \ivarx_3 \exists \ivarx_2.\ 10^{\ivarx_3} - 10^{\ivarx_2} \le \ivary + 1001 \wedge \ivarx_3 = \ivarx_1 + \ivarx_2.$$

Then, we enumerate different \emph{orders} of the quantified variables, i.e. $\ivarx_2$ and $\ivarx_3$. Since $\ivarx_3 = \ivarx_1 + \ivarx_2$, there is only one possible order, that is, $\ivarx_3 \ge \ivarx_2$.

Next, we illustrate how to eliminate the quantifier $\exists \ivarx_3$, assuming $\ivarx_3 \ge \ivarx_2$. The elimination of $\exists \ivarx_2$ is similar and simpler, thus omitted.

The elimination of $\exists \ivarx_3$ consists of two steps, namely, eliminating the exponential occurrences of $\ivarx_3$ first, and the linear occurrences next.

The main idea of the elimination of the exponential occurrences of $\ivarx_3$ is to observe that if $\ivarx_3 \ge \ell_{10}(\ivary+1001)+2$ and $\ivarx_3 \ge \ivarx_2 + 3$, then $10^{\ivarx_3} - 10^{\ivarx_2}$ is dominated by $10^{\ivarx_3}$, that is, $10^{\ivarx_3} - 10^{\ivarx_2} \ge 10^{\ivarx_3} - 10^{\ivarx_3 - 3} = (1-10^{-3}) 10^{\ivarx_3} \ge 10^{\ell_{10}(\ivary+1001)+1} = 10\lambda_{10}(\ivary+1001) > \ivary+1001$. Therefore, a necessary condition for $10^{\ivarx_3} - 10^{\ivarx_2} \le \ivary + 1001$ is that either $\ivarx_3 \le \ell_{10}(\ivary+1001)+1$ or $\ivarx_3 \le \ivarx_2 + 2$ holds.  
\begin{itemize}
\item If $\ivarx_3 \le \ell_{10}(\ivary+1001)+1$, then we distinguish between whether $\ivarx_3 \le \ell_{10}(\ivary+1001)$ or  $\ivarx_3 = \ell_{10}(\ivary+1001)+1$. 
\begin{itemize}
\item If $\ivarx_3 \le \ell_{10}(\ivary+1001)$, then $10^{\ivarx_3} - 10^{\ivarx_2} \le 10^{\ell_{10}(\ivary+1001)} = \lambda_{10}(\ivary+1001) \le \ivary + 1001$. In this case, $10^{\ivarx_3} - 10^{\ivarx_2} \le \ivary + 1001 \wedge \ivarx_3 = \ivarx_1 + \ivarx_2$ can simplified into $\ltrue$.
%
\item If $\ivarx_3 = \ell_{10}(\ivary+1001)+1$, then $10^{\ivarx_3} - 10^{\ivarx_2} \le \ivary + 1001$ can be turned into $10^{\ell_{10}(\ivary+1001)+1} - 10^{\ivarx_2} \le \ivary + 1001 \equiv 10 \lambda_{10}(\ivary+1001) - 10^{\ivarx_2} \le \ivary + 1001 $.
\end{itemize} 
%
\item If $\ivarx_3 \le \ivarx_2 + 2$, then $\ivarx_3 = \ivarx_2 + j$ for $j \in \{0,1,2\}$. Thus $10^{\ivarx_3} - 10^{\ivarx_2} \le \ivary + 1001$ can be transformed to $\bigvee \limits_{j \in \{0,1,2\}} 10^{\ivarx_2 + j} - 10^{\ivarx_2} \le \ivary + 1001$.
\end{itemize}

To summarize, $\varphi_1$ is transformed into 
\[
\small
\begin{array}{l}
\varphi_2 \Def \exists \ivarx_3 \exists \ivarx_2. \\
\begin{array}{l}
\vspace{2mm}
\left(
\begin{array}{l}
\ivarx_3 \le \ell_{10}(\ivary+1001)\ \vee \\
\left(
\begin{array}{l}
\ivarx_3 = \ell_{10}(\ivary+1001)+1\ \wedge \\
10 \lambda_{10}(\ivary+1001) - 10^{\ivarx_2} \le \ivary + 1001 
\end{array}
\right) \vee \\
%
 \bigvee \limits_{j \in \{0,1,2\}}  \left(\ivarx_3 = \ivarx_2 +j \wedge 10^{\ivarx_2 + j} - 10^{\ivarx_2} \le \ivary + 1001\right)
\end{array}
\right) 
\wedge \\
 \ivarx_3 = \ivarx_1 + \ivarx_2.
 \end{array}
\end{array}
\]
Note that $\varphi_2$ contains \emph{only linear} occurrences of $\ivarx_3$.

Finally, we can eliminate the linear occurrences of $\ivarx_3$, thus the quantifier $\exists \ivarx_3$, by applying the quantifier elimination algorithm of {\pa}, e.g. Cooper's algorithm in \cite{Cooper72}. The elimination of $\ivarx_3$ in $\varphi_2$ is simple, with $\ivarx_3$ replaced by $\ivarx_1 + \ivarx_2$, resulting into  
\[
\small
\begin{array}{l}
\varphi_3 \Def \exists \ivarx_2.\ 
\ivarx_1 + \ivarx_2 \le \ell_{10}(\ivary+1001)\ \vee \\
\left(
\begin{array}{l}
\ivarx_1 + \ivarx_2 = \ell_{10}(\ivary+1001)+1\ \wedge \\
10 \lambda_{10}(\ivary+1001) - 10^{\ivarx_2} \le \ivary + 1001 
\end{array}
\right) \vee \\
%
 \bigvee \limits_{j \in \{0,1,2\}}  \left(\ivarx_1 + \ivarx_2 = \ivarx_2 +j \wedge 10^{\ivarx_2 + j} - 10^{\ivarx_2} \le \ivary + 1001\right).
\end{array}
\]

\smallskip

In the remainder of this section, we are going to describe the aforementioned steps of the decision procedures: Normalization, the enumeration of the variable orders, 
the elimination of the exponential occurrences of variables. The elimination of the  linear occurrences of variables is essentially the quantifier elimination of the {\pa} and omitted.

Let us assume that $\varphi \Def \exists \ivarx.\ \varphi'(\ivarx, \vec{\ivary})$, where $\varphi'$ is a quantifier-free formula. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
\begin{definition}
    For a strictly increasing function $f:\mathbb{N}\mapsto \mathbb{N}$, 
    $f$ is said to be \emph{compatible with addition}
    if for every $m\in \mathbb{N}^+$,  $f$ modulo $m$ is periodic, 
    and for any term $A(x)=\sum_{1\le i\le n} a_i f(x+b_i)$, 
    where $n \in \mathbb{N}^+, a_i ,b_i \in \mathbb{Z}$,
    one of the following holds:
    \begin{itemize}
        \item $A(x)$ is bounded; 
        \item there exists a constant $\Delta_A\in \mathbb{N}^+$ such that 
        $\forall x. A(x+\Delta_A)\ge f(x)$;
        \item there exists a constant $\Delta_A\in \mathbb{N}^+$ such that 
        $\forall x. -A(x+\Delta_A)\ge f(x)$.
    \end{itemize}
\end{definition}

Semenov proved that for any function $f$ that is compatible with addition, the first order theory $(\mathbb{N},+,f)$ admits QE  and thus is complete and decidable \cite{Semenov84}. Exponential functions are a typical class of compatible with addition functions, and therefore {$\paexp$} is decidable. Particularly, in \cite{Point86} 
Point gave a detailed QE algorithm for $(\mathbb{N},+,2^x)$.
%下面这些感觉可以不用说，或者放在后面
%Unfortunately, Point's algorithm is flawed, one problem lies in the discussion to eliminate exponential terms. For example, after  eliminating variable $x$ in formula $\exists x. y\le 2^x \wedge x\le 10$, the expected result should be $y\le 2^{10} =1024$, but Point's algorithm will return a formula equivalent to $y \le 2^6=64$.

In this section, within Point's framework, we give a revised algorithm to the decision problem of {$\paexp$} with both improvements and corrections, that provides a crucial step to the decision procedure of string constraints with {\parseInt} function according to Theorem~\ref{thm:string-parInt}. 

%\section{Quantifier Elimination Algorithm for $(\mathbb{N},+,2^x)$}
% Based on Point's work \cite{Point86}, 
We will present a revised QE algorithm for {$\paexp$} formulas of the form $Qx.\theta(x,\bar{y})$, where $Q$ is a quantifier and $\theta(x,\bar{y})$ is a quantifier-free formula. Since $\forall x. F = \neg \exists x. \neg F$, we further assume the quantifier is an existential quantifier, that is, $\exists x.\theta(x,\bar{y})$. For eliminating quantifiers in arbitrary {$\paexp$} formula, we need to apply the algorithm to the innermost quantified formula and repeat this procedure until all quantifiers are eliminated.

The whole QE algorithm can be divided into 4 steps. The first step \textbf{Normalization} can be viewed as a pre-processing step, which substitutes ``complex" terms like $2^{2^x}$, $l_2(3x+y)$ with ``simple" terms by introducing new variables. After \textbf{Normalization}, we move forward to handle a ``simpler" formula, however, at the cost of more quantified variables.

The other three steps undertake the task to eliminate the newly introduced variables in \textbf{Normalization} step, denoted by $\{x_i:1\le i\le n\}$, and the original variable $x$ (will be denoted by $x_0$) one by one. 
The main body of \textbf{Enumerate-Orders} step is a loop to enumerate all possible orders among quantified variables $\{x_i : 0\le i \le n\}$. 
In each iteration, according the given (decreasing) order of quantified variables (corresponding to an outer \emph{for} loop), we invoke \textbf{Elim-exp} and \textbf{Elim-linear} to eliminate these variables one by one. 

During each iteration of the inner \emph{for} loop, if the maximal $x_i$ in $\bar{x}$ occurs in an exponential term in an atom, we will invoke \textbf{Elim-exp} to produce an equivalent formula where $x_i$ occurs linearly. Then \textbf{Elim-linear} will eliminate all linear occurrences of $x_i$, which is similar to the classic Cooper's QE algorithm for PA \cite{Cooper72}. 

A more detailed description is given below.
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Normalization}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
In order to show $(\mathbb{N},+,2^x)$ admits QE , 
it is sufficient to show that any 1-existential formula $\exists x.\theta(x,\bar{y})$ indeed does, 
where $\theta(x,\bar{y})$ is a quantifier-free formula. 
However, the form of $\exists x.\theta(x,\bar{y})$ is unknown so it may contain terms difficult to handle such as $2^{3x+y+1}$ or $l_2(x)$.
The \textbf{Normalization} step simplifies these terms by introducing new variables, 
for example, $\exists x.2^{3x+y+1}>10$ is equivalent to
$$\exists x\exists x_1.2^{x_1}>10 \wedge x_1 =3x+y+1\,.$$

Logarithm functions are replaced by exponential functions, take $\exists x.l_2(x)>3$ for example, $l_2(x)$ is replaced by a new variable $x_1$, and we have  
$$\exists x\exists x_1. x_1 > 3 \wedge 2^{x_1}\le x \wedge x\le 2^{x_1+1}-1\,.$$
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The normalization step comprises the following sub-steps.
\begin{enumerate}
\item At first, we transform $\varphi'(\ivarx,\vec{\ivary})$ into the NNF (negation normal form). Moreover, we remove the occurrences of $\neg$ by replacing $\neg c | \iterm$ with $\bigvee \limits_{j \in [c-1]} c | (\iterm+j)$, $\neg \iterm_1 = \iterm_2$ with $\iterm_1 < \iterm_2 \vee \iterm_2 < \iterm_1$, $\neg \iterm_1 < \iterm_2$ with $\iterm_2 \le \iterm_1$, $\neg \iterm_1 \le \iterm_2$ with $\iterm_2 < \iterm_1$, and so on.
%
\item Repeat the following procedure, until there are no $\lambda_{10}(\iterm)$ where $\ivarx$ occurs: Replace each occurrence of $\lambda_{10}$ in $\varphi'$, say $\lambda_{10}(\iterm)$, such that $\ivarx$ occurs in $\iterm$, by $10^{\ell_{10}(\iterm)}$. Let the resulting formula be $\varphi''$.
%
\item Then repeat the following procedure to $\varphi''$, until for each occurrence of $10^{\iterm}$ where $\ivarx$ occurs, we have $\iterm = \ivarx$: For each occurrence of the $\ell_{10}$ in $\varphi''$, say $\ell_{10}(\iterm)$, such that it contains $\ivarx$ but is not $\ivarx$, introduce a fresh variable, say $\ivarz$, 
%and let $\varphi''':= \exists \ivarz.\ \varphi''[\ivarz/\ell_{10}(\iterm)] \wedge 10^\ivarz \le \iterm < 10^{\ivarz + 1}$. 
and replace all occurrences of $\ell_{10}(\iterm)$ by $\ivarz$, moreover, add the constraint $10^\ivarz \le \iterm < 10^{\ivarz + 1}$ as a conjunct. Let $\varphi'''$ denote the resulting formula.  
%
\item Do the following replacements to $\varphi'''$ so that all the atomic formulas are of the form $\iterm_1 \le \iterm_2$ or $c | \iterm$: Replace every occurrence of $\iterm_1 \ge \iterm_2$ with $\iterm_2 \le \iterm_1$. Replace every occurrence of $\iterm_1 < \iterm_2$ (resp. $\iterm_1 > \iterm_2$) with $\iterm_1 \le \iterm_2 - 1$ (resp. $\iterm_2 \le \iterm_1-1$). Replace ever occurrence of $\iterm_1 = \iterm_2$ wtih $\iterm_2 \le \iterm_1 \wedge \iterm_1 \le \iterm_2$. Let $\varphi^\dag$ the resulting formula. 
%
\item Let $\vec{\ivarz} = \ivarz_1,\ldots, \ivarz_n$ be an enumeration of the freshly introduced variables. Then the result of the normalization procedure is 
$\exists \vec{\ivarz}\exists \ivarx.\ \varphi^\dag$.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
Then $\theta(x,\bar{y})$ becomes a Boolean combination (with only $\wedge$ and $\vee$) of literals.

Make substitutions by introducing new variables according to the \textit{while} statements in the pseudo-code. For consistency, we rename the original $x$ to be $x_0$ and assume $n$ new quantified variables are introduced.

%After introducing new variables and substitution, 
After substitutions, we obtain a formula where if an exponential term contains a quantified variable $x_i$, the term must be $2^{x_i}$.
We then collect all terms with $x_i (0\le i\le n)$ together, it will be of the form $s(\bar{x}) \Def \sum_{i=0}^{n} a_i 2^{x_i} + \sum_{i=0}^n b_i x_i$, where $a_i,b_i (0\le i \le n)$ are all constants.
Other terms including constants and terms of free variables $\bar{y}$ are collected, denoted by $t(\bar{y})$. Since $\bar{y}$ are free variables, we will regard $t(\bar{y})$ as a constant. Inequalities and equalities will all be transformed into $s(\bar{x})\le t(\bar{y})$, for example, $s(\bar{x}) = t(\bar{y})$ will be replaced by $s(\bar{x})\le t(\bar{y})\wedge t(\bar{y})\le s(\bar{x})$.
 end, the resulted formula $\theta'$ only contains literals of the forms $s(\bar{x})\le t(\bar{y})$, $k|s(\bar{x})+t(\bar{y})$ and $\neg  (k|s(\bar{x})+t(\bar{y}))$.


\begin{algorithm}[t]
    \SetAlgoLined
    \KwIn{1-existential formula $\exists x.\theta(x,\bar{y})$}
    \KwOut{n-existential formula $\exists \bar{x}.\theta'(\bar{x},\bar{y})$}
    
    $\theta' :=  \theta(x,\bar{y})$ \;
    Transform $\theta'$ into NNF\;
    \tcp{ i is used for counting the introduced variables }
    $i := 1$\; 
    \tcp{ $\bar{y}$ are regarded as constants} 
    \While{there is a term $l_2(t)$, $t$ is not a constant}
    {
        $\theta' :=  \theta'[x_i/l_2(t)] \wedge (2^{x_i}\le t) \wedge (t\le 2^{x_i+1}-1)$\;
        $i:= i+1$\;
    }
    \While{there is a term $2^t$, $t$ is not a variable $x_j(j<i)$ or a constant}
    {
        $\theta' :=  \theta'[2^{x_i}/2^t]\wedge (x_i\le t) \wedge (t \le x_i)$\;
        $i:= i+1$\;
    }
    $n:= i-1$\;
    \tcp{ Collect quantified variables}
    Transform all atoms of $\theta'$ into forms $s(\bar{x})\le t(\bar{y})$, $k|s(\bar{x})+t(\bar{y})$ or $\neg  (k|s(\bar{x})+t(\bar{y}))$\;
    Return $\exists x_0,...,\exists x_n. \theta'$
   
    \caption{Normalization}
\end{algorithm}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Enumeration of the variable orders} 

Let the output of the normalization procedure be $\exists \vec{\ivarx}.\ \varphi'$ with $\vec{\ivarx} = (\ivarx_1,\ldots, \ivarx_n)$. 
We then enumerate all the linear orders of $\{\ivarx_1,\ldots, \ivarx_n\}$. Each linear order can be represented by a permutation $\sigma \in \mathcal{S}_n$ (where $\mathcal{S}_n$ is the permutation group on $[n]$), with the intention that $\ivarx_{\sigma(n)} \ge \cdots \ge \ivarx_{\sigma(1)}$.

Assuming a linear order $\sigma \in \mathcal{S}_n$ of $\{\ivarx_1,\ldots, \ivarx_n\}$, we then consider $\varphi'_\sigma  = \exists \vec{\ivarx}.\ \varphi' \wedge \bigwedge \limits_{i \in [n-1]} \ivarx_{\sigma(i)} \le \ivarx_{\sigma(i+1)}$ and eliminate the quantifiers $\exists \ivarx_{\sigma(n)}$, $\ldots$, $\exists \ivarx_{\sigma(1)}$,  one by one and from left to right. Let $\varphi''_\sigma$ denote the resulting formula.

Finally, $\exists \vec{\ivarx}.\ \varphi'$ is transformed into the quantifier-free formula $\bigvee \limits_{\sigma \in \mathcal{S}_n} \varphi''_{\sigma}$. 

In the sequel, assuming a linear order $\sigma \in \mathcal{S}_n$, for $i \in [n]$, let $\exists \ivarx_{\sigma(i)} \ldots \exists \ivarx_{\sigma(1)}.\ \varphi''_{\sigma,i}$ be the formula obtained from $\varphi'_\sigma$ by eliminating the quantifiers $\exists \ivarx_{\sigma(n)}$, $\ldots$, $\exists \ivarx_{\sigma(i+1)}$, we show how to eliminate the exponential occurrences of $\ivarx_{\sigma(i)}$ in $\exists \ivarx_{\sigma(i)} \ldots \exists \ivarx_{\sigma(1)}.\ \varphi''_{\sigma,i}$. We would like to remark that the linear occurrences of $\ivarx_{\sigma(i)}$ should be eliminated further so that the quantifier $\exists \ivarx_{\sigma(i)}$ can be eliminated. The elimination of linear occurrences of $\ivarx_{\sigma(i)}$ is essentially the quantifier elimination algorithm of {\pa}.
%$\varphi'_\sigma =  \exists \vec{\ivarx}.\ \varphi' \wedge \bigwedge \limits_{i \in [n-1]} \ivarx_{\sigma(i)} \le \ivarx_{\sigma(i+1)}$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
In the \textbf{Normalization} step, we simplify the origin formula at the cost of more quantified variables. Suppose we get $\exists \bar{x}.\theta(\bar{x},\bar{y})$ and it has $n$ new variables $x_i$. As a consequence, we need to eliminate all $(n+1)$ quantified variables one by one. 

%To the end, 
We denote the set of all orders among the $(n+1)$ variables by $S_{n+1}$, and then enumerate these orders one by one in the outer \textit{for} loop. For the considered order $\sigma$, we first add the ordering information to $\theta$, and then according to the order, to eliminate $x_{\sigma(i)}$ for $i=n$ to $0$ by invoking \textbf{Elim-exp} first, and then invoking \textbf{Elim-linear} (the inner \textit{for} loop). In each iteration of the inner \textit{for} loop, if $x_{\sigma{(i)}}$ occurs in an exponential term in an atom $\tau$, \textbf{Elim-exp} is invoked to produce a formula, in which $x_i$ occurs linearly, equivalent to $\theta$;  
then $x_i$ occurs only linearly, thus \textbf{Elim-linear} is further invoked to eliminate all (linear) occurrences of $x_i$. The returned formula is the disjunction of all formulas resulted in all iterations of the outer \textit{for} loop. 
 
\iffalse
put , We now specify an order of $\bar{x}$, and recursively eliminate the maximal element in the remaining $\bar{x}$. 
That is to say,
every execution of \textbf{Elim-exp} and \textbf{Elim-linear} will eliminate the largest element $x_i$ in $\bar{x}$.
However, as you may notice, if there is no clue about the order of $\bar{x}$, 
we will have to use the idea of permutation group and the number of sub-cases will blow up, in the worst case, $(n+1)!$ cases. 

Here is how \textbf{Elim-exp} and \textbf{Elim-linear} are invoked in
\textb
At thef{Ordering and QE}. 
\fi

\begin{algorithm}[t]
    \SetAlgoLined
    \KwIn{a normalized $(n+1)$-existential formula $\exists \bar{x}.\theta(\bar{x},\bar{y})$, where $\bar{x}=(x_0,...,x_n)$} 
    \KwOut{an equivalent quantifier-free formula without $\bar{x}$}
    \tcp{Let $S_{n+1}$ denote the group of permutations on $\{0,1,...,n\}$}
    $\phi := \textit{False}$\;
    \For{each $\sigma \in S_{n+1}$ }
    {
        $\theta_{\sigma}:=  \theta(\bar{x},\bar{y})\wedge \bigwedge_{j=0}^{n-1}(x_{\sigma(j)}\le x_{\sigma(j+1)})$\;
        
        \tcp{recursively eliminate the maximal $x_i$ in $\bar{x}$}
        %\znj{How to effectively determine the maximal $x_i$?} 
        \For{i from n to 0}
        {
            \tcp{if $x_{\sigma(i)}$ occurs exponentially in $\theta_\sigma$}
            $\theta_{\sigma}:= \textbf{Elim-exp}(x_{\sigma(i)},\theta_{\sigma})$\;
            \tcp{now $x_{\sigma(i)}$ occurs only linearly in $\theta_\sigma$}
            $\theta_{\sigma}:= \textbf{Elim-linear}(x_{\sigma(i)},\theta_{\sigma})$\;
        }
        $\phi :=  \phi \vee \theta_{\sigma}$\;
    }
    output $\phi$
    \caption{Enumerate-Orders}
\end{algorithm}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Elimination of  exponential occurrences of variables}\label{sec-elim-exp}

Let $i \in [n]$ and $\exists \ivarx_{\sigma(i)} \ldots \exists \ivarx_{\sigma(1)}.\ \varphi''_{\sigma,i}(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ be the formula obtained from $\varphi'_\sigma$ by eliminating the quantifiers $\exists \ivarx_{\sigma(n)}$, $\ldots$, $\exists \ivarx_{\sigma(i+1)}$. We show how to eliminate the exponential occurrences of $\ivarx_{\sigma(i)}$ in $\varphi''_{\sigma,i}$. The elimination is \emph{local} in the sense that it is applied to the atomic formulas independently. 

Recall that after normalization, the atomic formulas are of the form $\iterm_1 \le \iterm_2$ or $c | \iterm$. Therefore, we can assume that the atomic formulas in $\varphi''_{\sigma,i}$ are  of the form 
%
$$a_i 10^{\ivarx_{\sigma(i)}}+\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i}b_k \ivarx_{\sigma(k)} \le \iterm(\vec{\ivary})$$
or  
$$c \big | \big(a_i 10^{\ivarx_{\sigma(i)}}+\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i}b_k \ivarx_{\sigma(k)} + \iterm(\vec{\ivary})\big).$$
%
For convenience, let us call these formulas as inequality respectively divisibility atomic formulas. In the sequel, we illustrate how to eliminate the exponential occurrences of $\ivarx_{\sigma(i)}$ for these two types of atomic formulas.

\medskip

\paragraph{Inequality atomic formulas} Let us consider 
$$
\begin{array}{l}
\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary}) \Def  \\
\hspace{4mm} 
a_i 10^{\ivarx_{\sigma(i)}}+\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i}b_k \ivarx_{\sigma(k)} \le \iterm(\vec{\ivary}).
\end{array}
$$

The elimination of the exponential occurrences of $\ivarx_{\sigma(i)}$ in $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ relies on the following lemma. Intuitively, the lemma states the fact that if $\ivarx_{\sigma(i)}$ is sufficiently greater than $\ivarx_{\sigma(i-1)}$, then the left-hand-side of $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ is \emph{dominated} by $a_i10^{\ivarx_{\sigma(i)}}$, moreover, if $a_i > 0$ and the value of $\ivarx_{\sigma(i)}$ is sufficiently small (resp. big), then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ holds (resp. does not hold), similarly for $a_i < 0$.

\begin{lemma} \label{lem:exp-ineq}
Let  
%
$$
\begin{array}{l}
\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary}) \Def  \\
\hspace{4mm} 
a_i 10^{\ivarx_{\sigma(i)}}+\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i}b_k \ivarx_{\sigma(k)} \le \iterm(\vec{\ivary}).
\end{array}
$$
%
with $a_i \neq 0$, $A\Def \sum_{j=1}^{i-1}|a_j|$, 
%$B\Def  \sum_{j=1}^{i}|b_j|$, 
$B \Def 10(\ell_{10}(\sum_{j=1}^{i}|b_j|)+3)$,
and $\delta\Def  \ell_{10}(A)+3$. 
\begin{itemize}
    \item If $a_i > 0$, let $\alpha(\vec{\ivary}) \Def \ell_{10}(\iterm(\ivary))- \ell_{10}(a_i)$, then 
    \begin{itemize}
        \item if $\ivarx_{\sigma(i)} \le \alpha(\vec{\ivary})  -1$, $\ivarx_{\sigma(i)} \ge B$ and $\ivarx_{\sigma(i)} \ge \ivarx_{\sigma(i-1)} +\delta $, then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ holds,
        \item if $\ivarx_{\sigma(i)} \ge \alpha(\vec{\ivary})  +2$, $\ivarx_{\sigma(i)} \ge B$ and $\ivarx_{\sigma(i)}  \ge \ivarx_{\sigma(i-1)} +\delta$, then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ \textbf{does not} hold.
    \end{itemize}
    \item If $a_i < 0$, let $\alpha(\vec{\ivary})  \Def \ell_{10}(-\iterm(\ivary))- \ell_{10}(-(a_i))$, then 
    \begin{itemize}
        \item if $\ivarx_{\sigma(i)} \le \alpha(\vec{\ivary})  -1$, $\ivarx_{\sigma(i)} \ge B$ and $\ivarx_{\sigma(i)} \ge \ivarx_{\sigma(i-1)} +\delta $, then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ \textbf{does not} hold,
        \item if $\ivarx_{\sigma(i)} \ge \alpha(\vec{\ivary})  +2$, $\ivarx_{\sigma(i)} \ge B$ and $\ivarx_{\sigma(i)} \ge \ivarx_{\sigma(i-1)} +\delta $, then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ holds.
    \end{itemize}
\end{itemize}
\end{lemma}

If $a_i > 0$, then from Lemma~\ref{lem:exp-ineq}, $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ is equivalent to 
\[
\small
\begin{array}{l}
\bigvee \limits_{p=0}^{B-1} a_i 10^{p}+\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + b_i p + \sum_{k=1}^{i-1}b_k \ivarx_{\sigma(k)} \le \iterm(\vec{\ivary}) \\
\bigvee \big(\ivarx_{\sigma(i)} \ge B \wedge \ivarx_{\sigma(i)} \le \alpha(\vec{\ivary})  -1  \wedge \ivarx_{\sigma(i)} \ge \ivarx_{\sigma(i-1)} +\delta \big)\\
\bigvee 
\left(
\begin{array}{l}
\ivarx_{\sigma(i)} \ge B \wedge \ivarx_{\sigma(i)} = \alpha(\vec{\ivary})\ \wedge \\
\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})[\alpha(\vec{\ivary})/\ivarx_{\sigma(i)}]
\end{array}
\right)  \\
\bigvee 
\left(
\begin{array}{l}
\ivarx_{\sigma(i)} \ge B \wedge \ivarx_{\sigma(i)} = \alpha(\vec{\ivary})+1\ \wedge \\
\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})[\alpha(\vec{\ivary})+1/\ivarx_{\sigma(i)}]
\end{array}
\right)  \\
\bigvee \bigvee \limits_{p=0}^{\delta-1} 
\left(
\begin{array}{l}
\ivarx_{\sigma(i)} \ge B \wedge \ivarx_{\sigma(i)} \ge \alpha(\vec{\ivary})+2\ \wedge \\
 \tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})[\ivarx_{\sigma(i-1)}+ p /\ivarx_{\sigma(i)}]
\end{array}
\right),
\end{array}
\]
where the exponential occurrences of $\ivarx_{\sigma(i)}$ disappear.

The elimination of the exponential occurrences of $\ivarx_{\sigma(i)}$ for the case $a_i < 0$ is similar. 

\medskip

\paragraph{Divisibility atomic formulas} Consider
%
$$
\begin{array}{l}
\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary}) \Def  \\
c\ \big |\ \big(a_i 10^{\ivarx_{\sigma(i)}} + \sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i} b_k \ivarx_{\sigma(k)} 
+ \iterm(\vec{\ivary}) \big)
\end{array}
$$
with $a_i \neq 0$.
%

Let $c = 2^{r_1} 5^{r_2}  c_0$ such that $c_0$ is divisible by neither $2$ nor $5$. Moreover, let $r = \max(r_1, r_2)$. Then $c | (10^rc_0)$. 

If $c_0 = 1$, then $10^r$ is divisible by $c = 2^{r_1}5^{r_2}$. Thus for every $n \ge r$, $c \ |\ 10^n$.  Therefore, in this case, $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ is equivalent to 
\[
\small
\begin{array}{l}
\bigvee \limits_{p = 0}^{r - 1} c\ \big | \big(a_i 10^{p} + \sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + b_kp + \sum_{k=1}^{i-1} b_k \ivarx_{\sigma(k)} 
+ \iterm(\vec{\ivary}) \big)\\
%
\vee \big(\ivarx_{\sigma(i)} \ge r \wedge c\ \big | \big(\sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \sum_{k=1}^{i} b_k \ivarx_{\sigma(k)} 
+ \iterm(\vec{\ivary}) \big)\big),
\end{array}
\]
where the exponential occurrences of $\ivarx_{\sigma(i)}$ disappear.

Next, let us assume $c_0 > 1$. Since $10$ and $c_0$ are relatively prime, according to Euler's theorem (cf. \cite{HW80}), $10^{\phi(c_0)} \equiv 1 \bmod c_0$, where $\phi$ is the Euler function. Suppose $10^{\phi(c_0)} = kc_0 + 1$ for some $k \in \Nat$. 
Then for every $n \in \Nat$ with $n \ge r$, 
$$
\begin{array}{l}
10^{n + \phi(c_0)} \bmod c =10^{n-r} 10^r (kc_0 + 1) \bmod c = \\
10^{n-r} (k 10^rc_0 + 10^r) \bmod c = \\
10^{n-r} (0+10^r) \bmod c = 10^n \bmod c.
\end{array}
$$

Then $\tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})$ is equivalent to 
\[
\begin{array}{l}
\bigvee \limits_{p=0}^{r-1} \tau(\ivarx_{\sigma(i)}, \ldots, \ivarx_{\sigma(1)}, \vec{\ivary})[p/\ivarx_{\sigma(i)}]\ \vee \\
\left(
\begin{array}{l}
\ivarx_{\sigma(i)} \ge r\ \wedge \\
\bigvee \limits_{q = 0}^{\phi(c_0)-1} 
\left(
\begin{array}{l}
\phi(c_0)\ \big |\ (\ivarx_{\sigma(i)} - r - q)\ \wedge \\
c\ \big | 
\left(
\begin{array}{l}
a_i 10^{r+q} + \sum_{j=1}^{i-1} a_j 10^{\ivarx_{\sigma(j)}} + \\
\sum_{k=1}^{i} b_k \ivarx_{\sigma(k)} + \iterm(\vec{\ivary})
\end{array}
\right) 
\end{array}
\right)
\end{array}
\right),
\end{array}
\]
where the exponential occurrences of $\ivarx_{\sigma(i)}$ disappear.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
Let $d = 2^rd_0$, $d_0$ is an odd natural number. 
According to Euler's Theorem, 
$gcd(2,d_0)=1$ implies
$2^{\phi(d_0)} \text{mod}\ d_0 = 1$,
where $\phi$ is the Euler function.
Consider function $f(n)=(2^n\ \text{mod} \ d)$,
when $n\ge r$, 
$f(n)$ becomes a periodic function and its period is a divisor of $\phi(d_0)$ because
\begin{align}
    f(n+\phi(d_0)) 
    &=2^{n+\phi(d_0)}\ \text{mod}\ d &\notag\\
    &=2^n\cdot 2^{\phi(d_0)}\ \text{mod}\ d &\notag\\
    &=2^n\cdot (k d_0 + 1) \ \text{mod}\ d &
    (\mbox{assume } 2^{\phi(d_0)}=k d_0 +1) \notag \\
    &= 2^n \ \text{mod}\ d &
    (\mbox{when } n\ge r, 2^n d_0\ \text{mod}\ d = 0 )\notag\\
    &= f(n) \notag
\end{align}

When $x_i\le r-1$, we just enumerate all possible value of $x_i$, i.e., 
$$\rho_5 \Def \bigvee_{p=0}^{r-1} \tau(p,\bar{x},\bar{y})\,.$$
When $x_i\ge r$, $\tau(x_i,\bar{x},\bar{y})$ is equivalent to
$$
\rho_6 \Def \bigvee_{q=0}^{\phi(d_0)-1} [d|(a_i 2^{r+q}+\sum_{j=0}^{i-1} a_j 2^{x_j}
+  \sum_{k=0}^{i} b_k x_k+t(\bar{y})) \wedge \phi(d_0)|(x_i-r-q) \wedge x_i \ge r] \,.
$$
            Therefore,  $\tau(x_i,\bar{x},\bar{y})$ is equivalent to  $\rho_5 \vee \rho_6$.
            
\textbf{Elim-exp} is the most technical part of our QE algorithm. As mentioned, \textbf{Elim-exp} takes $\theta_{\sigma}(\bar{x},\bar{y})$ and  variable $x_{\sigma(i)}$ (the maximal variable among all quantified variables that are not eliminated yet according to $\sigma$) as inputs, and outputs an equivalent formula in which $x_{\sigma(i)}$ occurs linearly.
The ideal case is that the formula $\theta(\bar{x},\bar{y})$ itself contains no $2^{x_{\sigma(i)}}$ terms, so we can omit this step and directly go to \textbf{Elim-linear}.
For simplicity, we will abuse notations $x_i$ for $x_{\sigma(i)}$, and $\bar{x}$ for $(x_{\sigma(0)},...,x_{\sigma(i-1)})$ ( remind that $x_{\sigma(i+1)},...,x_n$ have been eliminated already).

After normalization, the formula $\theta(\bar{x},\bar{y})$ contains atoms of three forms corresponding to 
the predicates $\le$, $|$ and negation of $|$, respectively.
The problem will be discussed in two cases depending on the form of the atom $\tau$ that contains $2^{x_i}$, 
corresponding to \textbf{Elim-exp-ineq} or \textbf{Elim-exp-div}. 

%We first give the whole procedure of \textbf{Elim-exp},and then provide the details of the two sub-routines.

\begin{algorithm}[t]
    \SetAlgoLined
    \KwIn{$x_i$ and $\theta$, $x_i$ is larger than $x_0$ to $x_{i-1}$
    and occurs exponentially in $\theta$} 
    \KwOut{a formula equivalent to $\theta$ where $x_i$ occurs linearly}
    
    \While{there is an atom $\tau(x_i,\bar{x},\bar{y})$ contains $2^{x_i}$}
    {
        $\Psi:= \textit{False}$\;
        \eIf{$\tau$ is of the form $a_i 2^{x_i}+\sum_{j=0}^{i-1} a_j2^{x_j} + \sum_{k=0}^{i}b_k x_k \le t(\bar{y})$}
        { 
            \tcp{ \textbf{Elim-exp-ineq} case}
            $A :=  \sum_{j=0}^{i-1}|a_j|$, $B:= b_i + \sum_{j=0}^{i-1}|b_j|$\;
            $B':= 2(l_2(B)+3)$, $\delta:=  l_2(A)+3$\;
            If $a_i>0$ then $\alpha := l_2(t(y))-l_2(a_i)$
            else $\alpha := l_2(-t(y))-l_2(-a_i)$\;
            
            $\rho_1 :=  (x_i \le \alpha -1 \wedge \bigvee_{0\le k\le B'}(x_i=k \wedge \tau[k/x_i] ))$
    
            $\quad \vee ( x_i \le \alpha -1 \wedge x_i\ge B' \wedge \bigvee_{0\le k \le \delta} (x_i = x_{i-1}+k \wedge \tau[x_{i-1}+k/x_i]))$\;
                
            $\rho_2 :=  (x_i = \alpha) \wedge \tau[\alpha/x_i]$\;
            $\rho_3 :=  (x_i = \alpha+1) \wedge \tau[\alpha+1/x_i]$\;
            $\rho_4 :=  (x_i \ge \alpha+2 \wedge \bigvee_{0\le k\le B'}(x_i=k \wedge \tau[k/x_i] ))$
        
            $\quad \vee (x_i \ge \alpha +2 \wedge x_i\ge B' \wedge \bigvee_{0\le k \le \delta}(x_i = x_{i-1}+k \wedge \tau[x_{i-1}+k/x_i]))
            $\;
            \eIf{$a_i>0$}
            {
                $\Psi := \rho_1 \vee \rho_2 \vee \rho_3 \vee \rho_4 
                \vee [x_i \le \alpha -1 \wedge x_i \ge B' \wedge x_i \ge x_{i-1}+\delta]$
            }
            {
                $\Psi := \rho_1 \vee \rho_2 \vee \rho_3 \vee \rho_4 
                \vee [x_i \ge \alpha +2 \wedge x_i \ge B' \wedge x_i \ge x_{i-1}+\delta]$    
            }
            }
        {
            \tcp{the atom is of the form $d|t(x_i,\bar{x},\bar{y})$}
            \tcp{ \textbf{Elim-exp-div} case}
            \tcp{ let $d=2^r d_0$ where $d_0$ is odd}
            $\rho_5 := \bigvee_{p=0}^{r-1} [\tau(p,\bar{x},\bar{y})\wedge x=p]$\;
            $\rho_6 := \bigvee_{q=0}^{\phi(d_0)-1} [d|(a_i 2^{r+q}+\sum_{j=0}^{i-1} a_j 2^{x_j}
            +  \sum_{k=0}^{i} b_k x_k+t(\bar{y})) \wedge \phi(d_0)|(x_i-r-q) \wedge x_i \ge r]
            $\;
            $\Psi :=  \rho_5 \vee \rho_6$
        }
        replace $\tau$ by $\Psi$ in $\theta$\;
    }
    \caption{Elim-exp}
\end{algorithm}


\subsubsection{Elim-exp-ineq}

This part deals with the case when $\tau$ is an inequality of the form 
$$\tau(x_i,\bar{x},\bar{y}) \Def  a_i 2^{x_i}+\sum_{j=0}^{i-1} a_j2^{d x_j} + \sum_{k=0}^{i}b_k x_k \le t(\bar{y})$$

We now try to eliminate $2^{x_i}$ in $\tau$, the idea is to find a bound for $x_i$, 
either by constants or by other variables.
We will prove the following theorem.

\begin{theorem} \label{thm:exp-ineq}
Assume that $x_i$ is the maximal variable in $\{x_0,...,x_{i}\}$ according to the given order, $\bar{x}$ denotes $\{x_0,...,x_{i-1}\}$.
Given an inequality $\tau(x_i,\bar{x},\bar{y})$ of the form  
$$\tau(x_i,\bar{x},\bar{y}) \Def  a_i 2^{x_i}+\sum_{j=0}^{i-1} a_j2^{d x_j} + \sum_{k=0}^{i}b_k x_k \le t(\bar{y})$$
with $a_i \neq 0$. Define $A\Def \sum_{j=0}^{i-1}|a_j|$, 
$B\Def |b_i| + \sum_{j=0}^{i-1}|b_j|$, 
$B'\Def 2(l_2(B)+3)$,
$\delta\Def  l_2(A)+3$, then 
\begin{itemize}
    \item if $a_i > 0$, let $\alpha \Def l_2(t(y))-l_2(a_i)$
    \begin{itemize}
        \item if $x_i \le \alpha -1$, $x_i \ge B'$ and $x_{i} \ge x_{i-1} +\delta $, then $\tau(x_i,\bar{x},\bar{y})$ holds.
        \item if $x_i \ge \alpha +2$, $x_i \ge B'$ and $x_{i} \ge x_{i-1} +\delta $, then $\tau(x_i,\bar{x},\bar{y})$ \textbf{does not} hold.
    \end{itemize}
    \item if $a_i < 0$, let $\alpha \Def l_2(-t(y))-l_2(-(a_i))$
    \begin{itemize}
        \item if $x_i \le \alpha -1$, $x_i \ge B'$ and $x_{i} \ge x_{i-1} +\delta $, then $\tau(x_i,\bar{x},\bar{y})$ \textbf{does not} hold.
        \item if $x_i \ge \alpha +2$, $x_i \ge B'$ and $x_{i} \ge x_{i-1} +\delta $, then $\tau(x_i,\bar{x},\bar{y})$ holds.
    \end{itemize}
\end{itemize}
\end{theorem}

Before proving \textbf{Theorem 1}, we need  the following lemma to estimate linear terms.

\begin{lemma} \label{lem:1}
For any $n,m\in \mathbb{N}$, if $n\ge m\ge 1$ and $x\ge 2(l_2(n)-l_2(m)+1)$, then 
$nx\le m2^x$ holds.
\end{lemma}

\begin{proof}
First we can prove that for any $N\in \mathbb{N}$, $x\ge 2N \implies 2^N x\le 2^x$. Let $N\Def l_2(n)-l_2(m)+1$, then we have $x\ge  2N \implies n x\le 2\lambda_2(n) x\le 2^N \lambda_2(m) x \le m 2^x $. \qed 
\end{proof}


Then we give the proof for Theorem~\ref{thm:exp-ineq}.
\begin{proof}
We only prove for the $a_i > 0$ case, the other case is analogous. 
The goal is to find a bound for $x_i$ such that 
the values of the atoms containing $x_i$ keep constant when $x_i$ is greater than the bound.

Note that $x_i$ is the largest among $\bar{x}$. 
suppose $x_i > x_{i-1} + \delta$, and let 
 $\delta \Def  l_2(A)+3$, then 
 \begin{equation} 
   2^{-\delta}A = \frac{A}{8\lambda_2(A)}\le \frac{1}{4}.   \label{eq:thm-ineq-1}
 \end{equation}
 When $x_i \ge B' = 2(l_2(4B)-l_2(1)+1)$, according to Lemma~\ref{lem:1}, 
\begin{equation} 
    4 B x_i \le 2^{x_i}. \label{eq:thm-ineq-2}
\end{equation}
 
When $x_i \ge \alpha+2$,
\begin{align}
    a_i2^{x_i}+ \sum_{j=0}^{i-1} a_j 2^{x_j} + \sum_{k=0}^{i} b_k x_k 
    & \ge a_i 2^{x_i} - 2^{x_i -\delta}A  - Bx_i & \notag \\
     & \ge 2^{x_i}(a_i -\frac{1}{4} -\frac{1}{4}) &  (\mbox{by \eqref{eq:thm-ineq-1} and  \eqref{eq:thm-ineq-2}})\notag \\
    %= &(a_i-\frac{1}{2})2^{x_i} \notag \\
    %\ge &\frac{a_i}{2}2^{x_i} \notag \\
    & \ge  \frac{a_i}{2}\frac{4\lambda_2(t(\bar{y}))}{\lambda_2(a_i)} & 
      (\mbox{ Def. of } \alpha) & \notag \\
     & \ge  t(\bar{y}) & \notag 
\end{align}
So we conclude that %when $x_i \ge \alpha+2,x_i\ge B',x_i \ge x_{i-1}+\delta$,
$\tau(x_i,\bar{x},\bar{y})$ keeps \textit{false} in this case.

When $x_i \le \alpha-1$, similarly we have
\begin{align}
    \tau(x_i,\bar{x},\bar{y})\notag 
    & \le  a_i 2^{x_i} + 2^{x_i -\delta}A  + Bx_i &  \notag \\
    & \le  2^{x_i}(a_i +\frac{1}{4} +\frac{1}{4}) &(\mbox{by \eqref{eq:thm-ineq-1} and  \eqref{eq:thm-ineq-2}}) \notag \\
   & \le  2\lambda_2(a_i)\frac{\lambda_2(t(\bar{y}))}{2\lambda_2(a_i)} &  (\mbox{ Def. of } \alpha) \notag \\
   &  \le  t(\bar{y}) & \notag 
\end{align}
which indicates that when  $x_i \le \alpha-1$, $\tau(x_i,\bar{x},\bar{y})$ keeps \textit{true}. \qed 
\end{proof}

\subsubsection{Elim-exp-div}

If $x_i$ occurs exponentially in an atom $\tau(x_i,\bar{x},\bar{y})$ of the form
$$\tau(x_i,\bar{x},\bar{y}) \Def  d| a_i 2^{x_i}+\sum_{j=0}^{i-1} a_j 2^{x_j} + \sum_{k=0}^{i} b_k x_k+t(\bar{y}) \quad (a_i \neq 0)\,,$$
the algorithm \textbf{Elim-exp-div} outputs an equivalent formula without $2^{x_i}$ terms.
The idea is that $a_i 2^x$ modulo $d$ is a periodic function when $x$ is large enough and the period can be computed.

Let $d = 2^rd_0$, $d_0$ is an odd natural number. 
According to Euler's Theorem, 
$gcd(2,d_0)=1$ implies
$2^{\phi(d_0)} \text{mod}\ d_0 = 1$,
where $\phi$ is the Euler function.
Consider function $f(n)=(2^n\ \text{mod} \ d)$,
when $n\ge r$, 
$f(n)$ becomes a periodic function and its period is a divisor of $\phi(d_0)$ because
\begin{align}
    f(n+\phi(d_0)) 
    &=2^{n+\phi(d_0)}\ \text{mod}\ d &\notag\\
    &=2^n\cdot 2^{\phi(d_0)}\ \text{mod}\ d &\notag\\
    &=2^n\cdot (k d_0 + 1) \ \text{mod}\ d &
    (\mbox{assume } 2^{\phi(d_0)}=k d_0 +1) \notag \\
    &= 2^n \ \text{mod}\ d &
    (\mbox{when } n\ge r, 2^n d_0\ \text{mod}\ d = 0 )\notag\\
    &= f(n) \notag
\end{align}

When $x_i\le r-1$, we just enumerate all possible value of $x_i$, i.e., 
$$\rho_5 \Def \bigvee_{p=0}^{r-1} \tau(p,\bar{x},\bar{y})\,.$$
When $x_i\ge r$, $\tau(x_i,\bar{x},\bar{y})$ is equivalent to
$$
\rho_6 \Def \bigvee_{q=0}^{\phi(d_0)-1} [d|(a_i 2^{r+q}+\sum_{j=0}^{i-1} a_j 2^{x_j}
+  \sum_{k=0}^{i} b_k x_k+t(\bar{y})) \wedge \phi(d_0)|(x_i-r-q) \wedge x_i \ge r] \,.
$$
            Therefore,  $\tau(x_i,\bar{x},\bar{y})$ is equivalent to  $\rho_5 \vee \rho_6$.
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\znj{\textbf{Solved}.More explanation or a formal proof is needed. }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hide{
\subsection{Elim-linear}

After \textbf{Elim-exp}, 
we obtain a formula (still denoted by $\theta(x_i,\bar{x},\bar{y})$) without $2^{x_i}$ terms,
i.e., $x_i$ occurs only linearly.
Now we wish to construct a formula without $x_i$ equivalent to $\exists x_i.\theta(x_i,\bar{x},\bar{y})$.
This can be done by 
following Cooper's QE algorithm for PA,
treating all $x_j (j<i)$ as free variables (like $\bar{y}$).
The procedure contains 3 steps.

Step 1: Put $\theta(x_i,\bar{x},\bar{y})$ in NNF form, replace atomic formulas containing symbols other than $\le,|$ by equivalent formulas only with $\le$, that is, $x=a$ by $x\le a \wedge a\le x$, $x< a$ by $x\le a+1$, $x\neq a$ by $x>a \vee x<a$,  $x\geq a$ by $-x \le -a$, and $x>a$ by $-x \le -a-1$.
In inequality atoms, collect terms of $x_i$
to one side and guarantee the coefficients of $x_i$ are positive.

Step 2: Let $d$ be the least common multiple of all coefficients of $x_i$. 
For atoms with $x_i$, multiply all terms by a factor so that the coefficient of $x_i$ is $d$.
We introduce a fresh variable $x_i'$, replace all occurrence of $dx_i$ by $x_i'$,
and denote the resulted formula by $\theta'(x_i')$.
Note that $x_i'$ is a multiple of $d$, 
so we set $\theta'=\theta'\wedge d|x'$.

We classify all atoms in $\theta$ into the following three sets:  
$L$ denotes all atoms of the form $t_l(\bar{x},\bar{y})\le x_i'$,
$U$ denotes all atoms of the form $x_i'\le t_u(\bar{x},\bar{y})$,
$M$ denotes all atoms of the form $k_m|x_i'+t_m(\bar{x},\bar{y})$ and their negations,
where $t(\bar{x},\bar{y})$ with a subscript is any term of $\bar{x}$ and $\bar{y}$ and 
$k_m \in \mathbb{N}$ for $m\in M$. % are integers in $$. 
%Then all atoms with $x_i'$ are of one of the types $L,U,M$.

Step 3: Let $\delta$ be the least common multiple of $\{k_m \mid m\in M\}$.
Construct $\theta'_{+\infty}(x_i')$ from $\theta'(x_i')$ by  
 replacing $\textit{true}$ for all atoms in $L$,
and $\textit{false}$ for all atoms in  $U$.
%We use $\theta'[t]$ to denote replacing all $x_i'$ by a term $t$. 
Then $\exists x_i'.\theta'(x_i')$
is equivalent to

$$\bigvee_{j=0}^{\delta-1} \theta'_{+\infty}[j/x_i'] \vee 
\bigvee_{j=0}^{\delta-1} \bigvee_{u\in U} \theta'[t_u(\bar{x},\bar{y})-j/x_i']$$

The first disjunction $\bigvee_{j=0}^{\delta-1} \theta'_{+\infty}[j/x_i']$ corresponds to the case where $x_i'$ is large enough 
so that all atoms in $L$ are \textit{true} and all atoms in  $U$ are \textit{false}. Thus $\theta'_{+\infty}$  contains only divisibility literals.
If there is a number $n (0\le n \le \delta-1)$ such that $ \theta'_{+\infty}[n/x_i']$ is evaluated to be \textit{true},
then for every $\lambda\in \mathbb{N}$,
$\theta'_{+\infty}[n+\lambda\delta/x_i']$ is also evaluated to be \textit{true}.
Hence, there exists $x_i'$ large enough to satisfy $\theta'$.

The second disjunction corresponds to the case that for 
some $u\in U, x_i'\le t_u(\bar{x},\bar{y})$ holds.
In this case, 
select the minimal $t_u(\bar{x},\bar{y})$
from atoms in $U$ that holds,
then there exists a solution for $x_i'$ such that $x_i'$ is in the interval $[t_u(\bar{x},\bar{y})-\delta+1,t_u(\bar{x},\bar{y})]$.

Here we describe Cooper's algorithm in pseudo code.
We will use $\theta\{\tau'/\tau\}$ to denote substitute all atoms $\tau$ with $\tau'$,
distinguished from term substitution $\theta[t'/t]$.

\begin{algorithm}[t]
    \SetAlgoLined
    \KwIn{$x_i,\theta(x_i,\bar{x},\bar{y})$,
    where $x_i$ occurs linearly} 
    \KwOut{A equivalent formula without $x_i$}
    
    Collect terms of $x_i$ in each atom\;
    Let $d$ to be the least common multiple of all coefficients of $x_i$\;
    Multiply each atom by a factor so that coefficient of $x_i $ is $d$\;
    Let $\theta'(x_i'):= \theta[x_i'/dx_i]$\;
    $\theta'(x_i') := \theta'(x_i') \wedge d| x_i'$\;
    \tcp{ Now the atoms have 3 different forms}
    \tcp{ $t_l(\bar{x},\bar{y})\le x_i'$, $x_i' \le t_u(\bar{x},\bar{y})$, $k_m|x_i'+t_m(\bar{x},\bar{y})$(or its negation)}
    \tcp{ where $l\in L,u\in U,m\in M$ are the index sets}
    $\delta :=  lcm\{k_m|m\in M\}$\;
    \For{all atom $\tau_l \in L$}
    {
        $\theta'_{+\infty}:=  \theta'\{\textit{true}/\tau_l\}$
    }
    \For{all atom $\tau_u \in U$}
    {
        $\theta'_{+\infty}:=  \theta'_{+\infty}\{\textit{false}/\tau_u\}$
    }
    output $\bigvee_{j=0}^{\delta-1} \theta'_{+\infty}[j/x_i'] \vee \bigvee_{j=0}^{\delta-1} \bigvee_{u\in U}\theta'[t_u(\bar{x},\bar{y})-j/x_i']$
    \caption{Elim-linear (Cooper's QE algorithm for PA)}
\end{algorithm}


\subsection{Compared with Point's Origin Algorithm}

Point's algorithm \cite{Point86} has four steps,
corresponding to the four steps of our algorithm respectively.
So we will use the names of our steps to refer to them. 
The divisible predicate $n|x$ is not included in his theory,
instead, the division operation $\frac{x}{n}$ where $n\in \mathbb{N}$ is allowed.
The \textbf{Normalization} and \textbf{Enumerate-Orders} steps in two algorithms are similar,
with some minor differences due to the setting of the theory.
The main differences between the two algorithms lies in the following aspects.

In \textbf{Elim-exp},
we adopt the same idea to find sufficient conditions
and necessary conditions for the formula to holds.
But our strategy for choosing parameters are easier to understand and use.
A flaw lies in the $a_i<0$ case in Point's algorithm 
\footnote{
In the $a_i<0$ case of \textbf{Elim-exp-ineq},
Point's algorithm assumes falsely $t(y)\ge 0$.
The reason for this mistake might be the confusion of 
two subtraction operators.
The example mentioned in \ref{sec:3.2} shows this case.
},
our \textbf{Elim-exp-ineq} corrects this flaw by 
treating $a_i<0$ case similarly to the $a_i>0$ case.

\textbf{Elim-linear} in Point's algorithm in some sense includes our
\textbf{Elim-exp-div}, because divisible predicates is not introduced in his setting.
In this step,
Point uses the permutation groups (just like $S_{(n+1)}$ in \textbf{Enumerate-Orders}) and needs recursively renaming of variables $x_i$.
We instead invoke the QE algorithm of PA without referring to permutation groups, 
other improved QE algorithm can also be used to simplify this step.

Point's algorithm has more restrictions on the form
of the formula.
Before \textbf{Elim-linear} and \textbf{Elim-exp} step,
it needs to transform the formula into disjunction normal form (DNF)
and deals with the basic case when input formula $\theta$ is 
a conjunction of atoms. 
It is well known that transforming an arbitrary formula into 
DNF is costly and the length of the formula may increase exponentially.
So our algorithm remove these limitations and assume no special forms of
the formula other than NNF.
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\iffalse
\subsection{Complexity Analysis and Case Study}
In this section, we give a complexity analysis of our decision procedure, and provide an example to demonstrate the procedure.
%\subsection{Complexity Analysis}

In this part, we estimate the complexity of our algorithm.
It can be divided into two part, 
the first part convert a string constraint $\phi$ to a PA formula with exponential functions,
and the second part is the QE procedure on the obtained formula.

Given a finite alphabet $\Sigma$ and $\alpha=\langle p,q \rangle$, the size of $\Sigma$ is denoted by
$|\Sigma|$. 
The generic $\alpha$-flat language contains $O(|\Sigma|^{pq})$ $\alpha$-flat languages


\paragraph{Complexity for QE}
In \textbf{Enumerate-Orders},
it reduces the origin problem to $(n+1)!$ sub-cases,
and for each case,
we recursively invoke \textbf{Elim-exp} and \textbf{Elim-linear}.
So the key is to analysis the inner \textit{for}
loop in \textbf{Enumerate-Orders}.
Note that if we omit the \textbf{Elim-exp} step,
the sub-cases are equivalent to Cooper's algorithm,
so we adopt the idea of Oppen's analysis to analyze the complexity
\cite{Oppen}.


Apply Cooper's algorithm on the quantified PA formula 
$Q_m x_m Q_{m-1}$ 
$x_{m-1} ... Q_1 x_1. $
$F(x_1,...,x_m)$,
the algorithm repeats $m$ times to eliminate
$x_1,...,x_m$ one by one.
Let $F_k \Def Q_m x_m Q_{m-1} 
x_{m-1} ... Q_{k+1} x_{k+1}. F_k'(x_{k+1},...,x_m)$
be the formula produced after $k$th iterations of the algorithm. 
Let $a_k$ denote the number of atoms in $F_k$,
$c_k$ denote the number of distinct $\delta_i$ in atom $\delta_i | t$ (and its negation) plus the number of distinct coefficients of variables.
$s_k$ denote the largest value of integer constant.
Use $a_0,c_0,s_0$ to denote the initial value of $a_k,c_k,s_k$ respectively.
The following theorem holds.

\begin{theorem}
for all $k: 1\le k\le m$, the following relations holds
\begin{itemize}
    \item $c_k \le {c_{k-1}}^4$
    \item $s_k \le {s_{k-1}}^{4c_{k-1}}$
    \item $a_k \le {a_{k-1}}^4 \cdot {s_{k-1}}^{2c_{k-1}}$
\end{itemize}
and from the above relations we have 
\begin{itemize}
    \item $c_k \le {{c_0}^4}^k$
    \item $s_k \le {{{s_0}^{4c_0}}^4}^k$
    \item $a_k \le {{a_0}^4}^k \cdot {{{s_0}^{4c_0}}^4}^k$
\end{itemize}
\end{theorem}

For each $k$,
the space required to store $F_k$ 
is $a_k \cdot (m+1) \cdot s_k \cdot q$,
where $(m+1)$ is the maximum number of constants per atom and $q>1$ is some constant. Assume $m\le n, c\le n, a\le n, s\le n$, we obtain the deterministic space complexity is ${{2^2}^2}^{p n log_n}$, which is also the bound for deterministic time.

In our algorithm,
we use the same denotations and have the following theorem. 
Note that each iteration corresponds to \textbf{Elim-exp} and \textbf{Elim-linear}.
\begin{theorem}
for all $k: 1\le k\le m$, the following relations holds
\begin{itemize}
    \item $c_k \le {c_{k-1}}^4$
    \item $s_k \le {(n s_{k-1})}^{4c_{k-1}}$
    \item $a_k \le {{(l_2(ns_{k-1})\cdot a_{k-1})}}^4 \cdot {(n s_{k-1})}^{2c_{k-1}}$
\end{itemize}
and from the above relations we have 
\begin{itemize}
    \item $c_k \le {{c_0}^4}^k$
    \item $s_k \le {{{n}^{4c_0}}^4}^k \cdot {{{s_0}^{4c_0}}^4}^k$
    \item $a_k \le {{a_0}^4}^k \cdot 
     {{{n}^{4c_0}}^4}^k
     \cdot {{{s_0}^{4c_0}}^4}^k$
\end{itemize}
\end{theorem}

WAIT TO CHECK!

Again assume $m,c,a,s\le n$, which gives 
$$
\textit{space}\le q \cdot {n^4}^n \cdot {{n^{(4n)}}^4}^n \cdot
{{n^{(4n)}}^4}^n \cdot (n+1) \cdot 
\cdot {{n^{(4n)}}^4}^n \cdot {{n^{(4n)}}^4}^n
\le 2^{2^{2^{p n \textit{log}n}}}
$$

Then the upper bound for Cooper's algorithm still holds for the inner \textit{for} loop of \textbf{Enumerate-Orders}.
When considering \textbf{Normalization} and permutations groups in \textbf{Enumerate-Orders},
since the super exponential term dominates the number of permutations $n^{O(n)}$,
this upper bound still holds.



 
%\subsection{Example}

We apply our algorithm to a simple example to 
illustrate its function.
Given $\Sigma = \{0,1\}$
Suppose $\mathcal{A}$ is a finite state automaton
that recognizes language $L = \{ w \mid \#w('1') \text{ is odd}\}$.
Consider the following string constraint
$$y\in L(\mathcal{A})\wedge 4\le  \parseInt(y) < 16\,.$$

We need an abstraction parameter $alpha$ to restrict interpretations
for $x$, for simplicity, set $\alpha\Def \langle 2,1 \rangle$.
The generic $\langle 2,1 \rangle$-flat language is the union of 
$\langle 2,1 \rangle$-flat languages $(11)^*,(10)^*,(01)^*,(00)^*,1^*,0^*$.
Here we divide the problem into 6 sub-cases by restricting $y$
to one of the $\langle 2,1 \rangle$-flat language.
Another approach is to directly restrict $y$ to 
the generic $\langle 2,1 \rangle$-flat language,
at the cost of more introduced variables.
Since the complexity is related to the number of variables,
we wish it to be as little as possible.

When $y$ is in language $1^*$, assume $y = 1^x$ where $x$
is a fresh integer variable.
Note that the Parikh image of $L(\mathcal{A})$ is $2|( x+1)$, 
so the constraint is converted to a PA formula $\phi$
$$\phi\Def \exists x. 2|(x+1) \wedge 5 \le 2^{x} < 17\,.$$

Observe that when $x=3$ the formula holds,
so we can easily deduce that $\phi$ is true.  
By applying our algorithm,
after \textbf{Normalization},
$\phi$ is transformed into the form 

$$\exists x_0. 2|(x+1)\wedge  2^{x}\le 16 \wedge -2^{x}\le -5\,.$$

Since there is only one variable, 
\textbf{Enumerate-Orders} can be omitted.
We send $2^x\le 16$ and $-2^x \le -5$ to \textbf{Elim-exp} and obtain
$$2^x\le 16 \equiv x \le 4$$
$$-2^x\le -5 \equiv 3\le x\,.$$ 
Then we apply \textbf{Elim-linear} on formula $\exists x_0. 2|(x+1) \wedge x\le 4 \wedge 3\le x$ and get
$$\bigvee_{j=0}^1(2| j+1 \wedge \textit{false} \wedge \textit{true})\vee \bigvee_{j=0}^1 (2|4-j+i\wedge 4-j\le 4 \wedge 3\le 4-j) \,.$$
which evaluates \textit{true} and we can deduce $j=1\implies x=3$, so $y$ is string $111$.

Other sub-cases are similar. However, when the abstraction parameter becomes larger,
say, $\alpha =\langle 2,2 \rangle$,
the complexity will grow rapidly,
because \textbf{Enumerate-Orders} can not always be omitted and formulas in \textbf{Elim-exp} can not be simplified easily.
\fi